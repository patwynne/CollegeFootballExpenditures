<!DOCTYPE html>
<html>

<head>
  <style>
  body {
    background-color: #F0F0F0;
  }
  svg {
    background-color: #FFFFFF;
    border-radius: 5px;
  }
  h1 {
    text-align: center;
  }
  #my_dataviz {
    text-align: center;
  }
  </style>
</head>

<body>
  <!-- Load d3.js -->
<h1> Fall 16 College Football Expenditures in Millions</h1>

  <script src="https://d3js.org/d3.v4.js"></script>

  <!-- Create a div where the graph will take place -->
  <div id="my_dataviz"></div>

  <script>
    // set the dimensions and margins of the graph
    var margin = {
        top: 10,
        right: 60,
        bottom: 30,
        left: 50
      },
      width = 925 - margin.left - margin.right,
      height = 725 - margin.top - margin.bottom;


    // Read the data and compute summary statistics for each specie
    d3.csv("http://patwynne.me/Football1617_clean.csv", function(data) {


      // Show the X scale
      var x = d3.scaleBand()
        .range([0, width])
        .domain(["Sun Belt", "MAC", "C-USA",  "Mountain West",  "AAC", "Independent",  "BIG 12","ACC", "PAC 12", "BIG TEN", "SEC" ])
        .paddingInner(1)
        .paddingOuter(.5)


      // Show the Y scale
      var y = d3.scaleLog()
        .domain([5, 65])
        .range([height, 0])

      var size = d3.scaleLinear()
        .domain([1, 65])
        .range([10, 60])

      var r_size = d3.scaleLinear()
        .domain([1, 65])
        .range([5, 35])


            // append the svg object to the body of the page
      var svg = d3.select("#my_dataviz")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")")
      .call(d3.axisLeft(y).tickFormat(d3.format(".0f")));


    svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x))






      var r = 25;
      // create a scale that'll return a discreet value
      // so that close y values fall in a line
      var yPtScale = y.copy()
        .range([Math.floor(y.range()[0] / r), 0])
        .interpolate(d3.interpolateRound)
        .domain(y.domain());

      // bucket the data
      var ptsObj = {};
      data.forEach(function(d,i) {
        var yBucket = yPtScale(d.TOTAL_EXPENSE_ALL);
        if (!ptsObj[d.Conference]){
          ptsObj[d.Conference] = {};
        }
        if (!ptsObj[d.Conference][yBucket]){
          ptsObj[d.Conference][yBucket] = [];
        }
        ptsObj[d.Conference][yBucket].push({
          cy: yPtScale(d.TOTAL_EXPENSE_ALL) * r,
          cx: x(d.Conference),
          src: d.Path,
          value: d.TOTAL_EXPENSE_ALL,
          college: d.Name
        });
      });

      // determine the x position
      for (var x in ptsObj){
        for (var row in ptsObj[x]) {
          var v = ptsObj[x][row], // array of points
              m = v[0].cx, // mid-point
              l = m - (((v.length / 2) * r) - r/2); // left most position based on count of points in the bucket

          v.forEach(function(d,i){
            d.cx = l + (r * i); // x position
          });
        }
      }

      // flatten the data structure
      var flatData = Object.values(ptsObj)
                      .map(function(d){return Object.values(d)})
                      .flat(2);

      svg
        .selectAll("points")
        .data(flatData)
        .enter()
        .append("image")
        .attr("class", "school")
        .attr("xlink:href", function(d){ return d.src })
        .attr("x", function(d) {return d.cx -12})
        .attr("y", function(d) {return d.cy})
        .attr("z", 1)
        .attr("height", 28)
        .attr("width", 28)
       .append("title")
       .text((d) => d.college + "\nFootball Expenditures: " + d.value + " million")
        .on("mouseover", function(d, i) {
            var xPos = +d3.select(this).attr("x")
            var wid = +d3.select(this).attr("width")
            d3.select(this)
            .attr("x", xPos - 10)
            .attr("width", wid + 20)
        }).on("mouseout", function() {
          d3.select(this).attr("x", function(d) {
            return x(d.Conference)
          })
          .attr("width", 25)
        });

        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - 55)
            .attr("x", 0 - (height / 2))
            .attr("dy", "2em")
            .style("text-anchor", "middle")
            .text("Total Football Expenses (Log Scale in Millions of $)")
            .style("fill", "black")
            .style("font-size","14px");
            d3.selectAll(".tick>text")
              .each(function(d, i){
                d3.select(this).style("font-size","14px");
              });


    })
  </script>
</body>

</html>
